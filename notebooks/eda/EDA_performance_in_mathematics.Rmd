---
title: 'EDA students performance in Mathematics'
author: "Erick Calderon-Morales"
date: ' Fall 2021'
due_date: ""
output:
  prettydoc::html_pretty:
    highlight: pygments
    theme: cayman
    toc: yes
    number_sections: no
    toc_depth: 1

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,comment = "", fig.align = 'center',
					  fig.width = 20, fig.height = 15)
```



```{r knitr, include = FALSE}

# Save figures in specific place

knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.comments = TRUE,
                      
                      # Include code?
                      echo           = TRUE,
                      
                      error          = FALSE,
                      fig.align      = "center",
                      
                      # Path to where to store pdf single figures
                      fig.path       = paste0("../eda/eda_figures/", "/"),
                      fig.width      = 20,
                      fig.height     = 15,
                      message        = FALSE,
                      warning        = FALSE)
```


```{r cleanup-docs, cache = FALSE,echo = FALSE}

# save a html copy file in a specific place
#doc.files <- c(list.files(pattern = "pdf"),
#               list.files(pattern = "html"),
#               list.files(pattern = "docx"))

#for (file in doc.files) {
#  cambiar nombre
#    file.rename(file, file.path("../../hw1/", file))
#}
```


```{r libaries, message=FALSE, warning=FALSE, cache=FALSE}
library(tidyverse)
library(janitor)
library(GGally)
library(tidyr)
library(Hmisc)
library(cowplot)
library(viridis)
library(DT)
library(GGally)
```

```{r}
# Load data
raw_data  <- read.table("../../data/raw_student-mat.csv", sep= ";", header=TRUE) 
```


```{r}
raw_data[is.na(raw_data)]
```
# EDA goal

The general goals of this EDA is to explore the distribution of each predictor and the response variable and clean the raw data for the models.


# Data set for eda
```{r}
eda_data  <-  
    raw_data  %>% 
        clean_names() %>% 
  
        # Transform variables to numeric
        mutate(g3 = as.numeric(g3),
               g2 = as.numeric(g2),
               g1 = as.numeric(g1),
               age = as.numeric(age),
               absences = as.numeric(absences)) %>%
        
        # Transform chr type to factor
        mutate(across(where(is.character), as.factor)) %>% 
        
        # Transform intergers to factor except absences and age  
         mutate(across(where(is.integer), as.factor)) %>%
  
        # Add g3 as binary for part A2 of the project         
        mutate(g3_binary = factor(if_else(g3 >= 10,"pass","fail" )))   
      
```


# Barplots

```{r}
# Set names, exclude response variables (g3 and g3_binary)
predictors_names <- set_names(names(eda_data)[-c(33:34)])
```


## For each predictor

+ In general most of the students, come from the school called Gabriela Pereira, live in most the cases in Urban areas, travel approximately 1h to get to school, dedicated 2h to studying, failed almost no class, do not received extra class support from the school, the parents support them to stay in school, attended to nursery school, want to take higher education, have internet access, have no romantic relationships and have a low alcoholic consumption during the workday.  


+ In terms of family, most of the students have families with size greater than 3 with both parents living in the same house. In most cases, both parents have some degree of education and have good family relationships.



```{r message=FALSE, warning=FALSE, fig.width = 20, fig.height = 25}

histogram_plot <-  function(x) {
     ggplot(eda_data, aes(x = .data[[x]])) +
          geom_bar()  +
          geom_text(aes(label = scales::percent(..prop..), group = 1), 
                    stat= "count", position = position_dodge(width = 0.9), 
                    size = 7) +
          theme_bw() +
          #scale_y_continuous(labels = scales::percent) +
          theme(axis.text=element_text(size = 21),
                axis.title=element_text(size = 21,face = "bold"),
                axis.text.x = element_text(angle = 25, hjust = 1)) 
}

plots_predictors <- map(predictors_names[-30], ~ histogram_plot(.x) ) 

cowplot::plot_grid(plotlist = plots_predictors, ncol = 4)
```

+ Also in terms of absences, there are 6 students with 30 absences or more.

```{r message=FALSE, warning=FALSE}
ggplot(eda_data, aes(x = absences)) +
          geom_histogram(stat = "count")  +
          theme_bw() +
          theme(axis.text=element_text(size = 21),
                axis.title=element_text(size = 21,face = "bold"),
                axis.text.x = element_text(angle = 25, hjust = 1)) 
```


## Correlations between predictors
```{r message=FALSE, warning=FALSE}
ggcorr(eda_data)
```

 

## For each predictor combined with the response variable 


The main goal of the plots below is to explore if any of predictors show any pattern within each of the values of the response variable. For example, in the top left corner is displays the how much the percentage of each score varies by school.     

+ Must of the  students that got a score of 19 come from families that have no more that 3 individuals 
+ Must of the  Students that got an score of 0 

+ There is no single predictor that show any trend. This makes me think that the score obtained the mathematics test are better explained with multiple predictors.  

```{r width = 10, height = 20}

g3_plot <-  function(x) {
    ggplot(eda_data, aes(x = g3, fill = .data[[x]])) +
    geom_bar(position = "fill") +
    theme_bw() +
    theme(axis.text=element_text(size = 15),
          axis.title=element_text(size = 15,face = "bold"),
          legend.position = "top",
          legend.key.size = unit(0.5, 'cm'),
          legend.title = element_text(size = 15), 
          legend.text = element_text(size = 12)) +
    scale_y_continuous(labels = scales::percent) +
    scale_fill_viridis(discrete = TRUE)
     
}

# Exclude numeric variables
#

plots_g3 <- map(predictors_names[-c(3,30,31,32)], ~ g3_plot(.x)) 

cowplot::plot_grid(plotlist = plots_g3, ncol = 4)
```


```{r echo = FALSE}
print(paste0("Number of individuals with a score equal to 4: ",length(eda_data$g3[eda_data$g3 == 4])))
print(paste0("Number of individuals with a score equal to 20: ",length(eda_data$g3[eda_data$g3 == 20])))
```

# Distribution of the Response Variable

+ There are 38 students that got a score equal to 0

```{r message=FALSE, warning=FALSE}
ggplot(eda_data, aes(x = g3)) +
          geom_histogram(stat = "count")  +
          theme_bw() +
          theme(axis.text=element_text(size = 21),
                axis.title = element_text(size = 21,face = "bold"))
```

# Boxplots

```{r width = 10, height = 20}
g3_boxplot <-  function(x) {
    ggplot(eda_data, aes(y = g3, x = .data[[x]])) +
     #geom_col(position = "fill") +
    geom_boxplot(outlier.shape = 14, outlier.size=2) +
    theme_light() +
    theme(axis.text=element_text(size = 15),
          axis.title=element_text(size = 15,face = "bold"),
          legend.position = "top",
          legend.key.size = unit(0.5, 'cm'),
          legend.title = element_text(size = 15)) 
          #legend.text = element_text(size = 12)) 

}


boxplots_g3 <- map(predictors_names[-c(3,30,31,32)], ~ g3_boxplot(.x) ) 

cowplot::plot_grid(plotlist = boxplots_g3 , ncol = 4)
```


# Removing predictors

__The following criteria where used to remove predictors:__

+ The fraction of unique values over the sample size is low (say 10 %).

+ The ratio of the frequency of the most prevalent value to the frequency of
the second most prevalent value is large (say around 20).

+ The predictors have a high correlation

```{r}
cor(eda_data$g1, eda_data$g2)
```

```{r}
eda_data %>%
  dplyr::select(is.factor) %>%
  gather(variable,level)   %>%   
  group_by(variable,level) %>%
  count() %>% 
  DT::datatable()
```


Based on these criteria I decided to remove:

+ school, pstatus, failures, schoolsup and higher.


# Save clean dataset

```{r}
clean_data  <-  
    raw_data  %>% 
        clean_names() %>% 
  
        # Transform variables to numeric
        mutate(g3 = as.numeric(g3),
               g2 = as.numeric(g2),
               g1 = as.numeric(g1),
               age = as.numeric(age),
               absences = as.numeric(absences)) %>%
        
        # remove varaibles
        dplyr::select(-c(school, pstatus, failures, schoolsup, higher)) %>% 
        
        # Transform chr type to factor
        mutate(across(where(is.character), as.factor)) %>%
  
        # Add g3 as binary for part A2 of the project         
        mutate(g3_binary = factor(if_else(g3 >= 10,"pass","fail" )))   
```

# Summary of the data

+ The data set has a total of 395 observation and 31 variables. 18 of these I consider are better if are treated as factors. G1 , G3, Age and Absences are treated as numeric and med, fedu, famrel free_time, go out, walc, dalc, health, travel time and study time are treated as integers.  

```{r  fig.width = 15, fig.height = 13}
str(clean_data)
```

```{r echo = FALSE}
if(!"clean_data_student_math_performance.csv" %in% dir("../../data/")) {
  
  write.csv(clean_data, file = "../../data/clean_data_student_math_performance.csv")
  print("Clean dataset saved")
  
  } else{

  print("Clean dataset saved")
  }
```









